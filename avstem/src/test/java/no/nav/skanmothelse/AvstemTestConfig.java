package no.nav.skanmothelse;

import com.slack.api.Slack;
import com.slack.api.methods.MethodsClient;
import lombok.extern.slf4j.Slf4j;
import no.nav.skanmothelse.azure.AzureOAuthEnabledWebClientConfig;
import no.nav.skanmothelse.azure.AzureProperties;
import no.nav.skanmothelse.config.properties.JiraAuthProperties;
import no.nav.skanmothelse.config.properties.SkanmothelseProperties;
import no.nav.skanmothelse.config.properties.SlackProperties;
import no.nav.skanmothelse.metrics.DokCounter;
import org.apache.sshd.common.file.virtualfs.VirtualFileSystemFactory;
import org.apache.sshd.common.keyprovider.ClassLoadableResourceKeyPairProvider;
import org.apache.sshd.scp.server.ScpCommandFactory;
import org.apache.sshd.server.SshServer;
import org.apache.sshd.server.auth.UserAuthNoneFactory;
import org.apache.sshd.server.auth.pubkey.AcceptAllPublickeyAuthenticator;
import org.apache.sshd.sftp.server.SftpSubsystemFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.Primary;
import org.springframework.context.annotation.Profile;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.time.Clock;
import java.time.Instant;

import static java.lang.Integer.parseInt;
import static java.util.Collections.singletonList;
import static no.nav.skanmothelse.CoreConfig.DEFAULT_ZONE_ID;

@Slf4j
@EnableAutoConfiguration
@EnableConfigurationProperties({
		SkanmothelseProperties.class,
		SlackProperties.class,
		JiraAuthProperties.class,
		AzureProperties.class,
})
@Import({
		CoreConfig.class,
		AvstemConfig.class,
		AvstemTestConfig.Config.class,
		AvstemTestConfig.SshdSftpServerConfig.class,
		DokCounter.class,
		AzureOAuthEnabledWebClientConfig.class
})
public class AvstemTestConfig {

	@Value("${skanmothelse.slack.url}")
	private String slackUrl;

	@Bean
	@Primary
	MethodsClient slackClient(SlackProperties slackProperties) {
		var slackClient = Slack.getInstance().methods(slackProperties.token());
		slackClient.setEndpointUrlPrefix(slackUrl);
		return slackClient;
	}

	@Configuration
	static class Config {
		@Bean
		@Primary
		@Profile("virkedag")
		Clock forrigeDagVirkedagClock() {
			Instant fixedInstant = Instant.parse("2025-08-01T10:00:00Z");
			return Clock.fixed(fixedInstant, DEFAULT_ZONE_ID);
		}

		@Bean
		@Primary
		@Profile("fridag")
		Clock forrigeDagFridagClock() {
			Instant fixedInstant = Instant.parse("2025-05-18T10:00:00Z");
			return Clock.fixed(fixedInstant, DEFAULT_ZONE_ID);
		}
	}

	@Configuration
	static class SshdSftpServerConfig {
		@Bean
		public Path sshdPath() throws IOException {
			return Files.createTempDirectory("sshd");
		}

		@Bean(initMethod = "start", destroyMethod = "stop")
		public SshServer sshServer(Path sshdPath,
								   SkanmothelseProperties skanmothelseProperties) {
			SshServer sshd = SshServer.setUpDefaultServer();
			sshd.setPort(parseInt(skanmothelseProperties.getSftp().getPort()));
			sshd.setKeyPairProvider(new ClassLoadableResourceKeyPairProvider("sftp/server_id_rsa"));
			sshd.setCommandFactory(new ScpCommandFactory());
			sshd.setSubsystemFactories(singletonList(new SftpSubsystemFactory()));
			// aksepterer alle public keys som presenteres, beh√∏ver ikke authorized_keys
			sshd.setPublickeyAuthenticator(AcceptAllPublickeyAuthenticator.INSTANCE);
			sshd.setUserAuthFactories(singletonList(new UserAuthNoneFactory()));
			sshd.setFileSystemFactory(new VirtualFileSystemFactory(sshdPath));
			return sshd;
		}
	}
}
